import os
import asyncio
import certifi
import requests
import traceback
from dotenv import load_dotenv
from langchain_mcp_adapters.client import MultiServerMCPClient

load_dotenv()

# Fix SSL issues in corporate environments
os.environ["SSL_CERT_FILE"] = certifi.where()


# -----------------------------
# AUTHENTICATION
# -----------------------------
def get_azure_access_token():
    tenant = os.getenv("AZURE_TENANT_ID")
    client_id = os.getenv("AZURE_CLIENT_ID")
    client_secret = os.getenv("AZURE_CLIENT_SECRET")

    if not tenant or not client_id or not client_secret:
        raise ValueError("Azure credentials missing in .env")

    url = f"https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"

    payload = {
        "client_id": client_id,
        "client_secret": client_secret,
        "scope": "https://analysis.windows.net/powerbi/api/.default",
        "grant_type": "client_credentials",
    }

    print("üîê Requesting Azure token...")
    response = requests.post(url, data=payload)
    response.raise_for_status()

    print("‚úÖ Azure token generated successfully")
    return response.json()["access_token"]


# -----------------------------
# INTENT CLASSIFIER
# -----------------------------
def classify_intent(question: str) -> str:
    q = question.lower()

    if "schema" in q:
        return "schema"

    if "cost" in q or "spend" in q:
        return "cost"

    return "unknown"


# -----------------------------
# PRINT SCHEMA
# -----------------------------
def print_schema(schema):
    print("\n================ DATASET SCHEMA ================\n")

    for table in schema["Tables"]:
        print(f"üìÅ {table['Name']}")
        for col in table["Columns"]:
            print(f"   ‚îî‚îÄ {col['Name']} ({col['Type']})")
        print()


# -----------------------------
# BUILD FOCUSED SCHEMA
# (Optional optimization)
# -----------------------------
def build_schema_selection(full_schema):

    relevant_tables = ["cost", "calendar", "resources"]

    tables = []
    for t in full_schema["Tables"]:
        if t["Name"] in relevant_tables:
            tables.append({
                "name": t["Name"],
                "columns": [c["Name"] for c in t["Columns"]],
                "measures": []
            })

    return {"tables": tables}


# -----------------------------
# MAIN EXECUTION
# -----------------------------
async def main():

    user_question = input("\nAsk your question: ").strip()

    intent = classify_intent(user_question)
    print(f"üîé Detected intent: {intent}")

    if intent == "unknown":
        print("‚ùå Unsupported question type")
        return

    workspace_id = os.getenv("POWERBI_WORKSPACE_ID")
    dataset_id = os.getenv("POWERBI_DATASET_ID")

    print("Using Workspace ID:", workspace_id)
    print("Using Dataset ID:", dataset_id)

    if not workspace_id or not dataset_id:
        raise ValueError("Missing POWERBI_WORKSPACE_ID or POWERBI_DATASET_ID in .env")

    token = get_azure_access_token()

    servers = {
        "powerbi-remote": {
            "transport": "http",
            "url": "https://api.fabric.microsoft.com/v1/mcp/powerbi",
            "headers": {
                "Authorization": f"Bearer {token}",
                "x-ms-powerbi-workspace-id": workspace_id
            }
        }
    }

    print("üîå Connecting to MCP server...")
    client = MultiServerMCPClient(servers)

    tools = await client.get_tools()
    tool_map = {tool.name: tool for tool in tools}

    print(f"‚úÖ Connected. Tools available: {list(tool_map.keys())}")

    # -----------------------------
    # SCHEMA REQUEST
    # -----------------------------
    if intent == "schema":
        try:
            print("üì° Requesting schema from MCP...")

            schema_tool = tool_map["GetSemanticModelSchema"]
            schema_result = await schema_tool.ainvoke({
                "artifactId": dataset_id
            })

            print("üîç Raw MCP Response:")
            print(schema_result)

            if not hasattr(schema_result, "artifact") or not schema_result.artifact:
                print("‚ùå MCP returned no artifact")
                return

            schema = schema_result.artifact.get("structured_content")

            if not schema:
                print("‚ùå structured_content missing in artifact")
                print(schema_result.artifact)
                return

            print_schema(schema)

        except Exception:
            print("\n‚ùå ERROR while fetching schema:")
            traceback.print_exc()

        return

    # -----------------------------
    # COST REQUEST
    # -----------------------------
    if intent == "cost":
        try:
            print("üì° Fetching schema...")

            schema_tool = tool_map["GetSemanticModelSchema"]
            schema_result = await schema_tool.ainvoke({
                "artifactId": dataset_id
            })

            full_schema = schema_result.artifact["structured_content"]

            schema_selection = build_schema_selection(full_schema)

            print("üß† Generating DAX from question...")

            generate_tool = tool_map["GenerateQuery"]
            dax_result = await generate_tool.ainvoke({
                "artifactId": dataset_id,
                "userInput": user_question,
                "schemaSelection": schema_selection
            })

            dax_query = dax_result.artifact["query"]

            print("\nGenerated DAX:\n")
            print(dax_query)

            print("üìä Executing query...")

            execute_tool = tool_map["ExecuteQuery"]
            data_result = await execute_tool.ainvoke({
                "artifactId": dataset_id,
                "daxQuery": dax_query
            })

            print("\nQuery Result:\n")
            print(data_result.artifact)

        except Exception:
            print("\n‚ùå ERROR during cost pipeline:")
            traceback.print_exc()

        return


# -----------------------------
# ENTRY POINT
# -----------------------------
if __name__ == "__main__":
    asyncio.run(main())
