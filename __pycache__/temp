import os
import asyncio
import certifi
import requests
from dotenv import load_dotenv
from langchain_mcp_adapters.client import MultiServerMCPClient
from langchain.chat_models import init_chat_model
from langchain.agents import create_agent

load_dotenv()

# Fix SSL issues in corporate environments
os.environ["SSL_CERT_FILE"] = certifi.where()


def get_azure_access_token():
    """
    Generates Azure AD token using Service Principal
    """
    tenant = os.getenv("AZURE_TENANT_ID")
    client_id = os.getenv("AZURE_CLIENT_ID")
    client_secret = os.getenv("AZURE_CLIENT_SECRET")

    if not tenant or not client_id or not client_secret:
        raise ValueError("Azure credentials missing in .env")

    url = f"https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"

    payload = {
        "client_id": client_id,
        "client_secret": client_secret,
        "scope": "https://analysis.windows.net/powerbi/api/.default",
        "grant_type": "client_credentials",
    }

    response = requests.post(url, data=payload)
    response.raise_for_status()

    print("âœ… Azure token generated successfully")
    return response.json()["access_token"]


def extract_mcp_schema(result):
    """
    Extract ONLY the MCP structured payload (ignore LangChain metadata)
    """
    for msg in result["messages"]:
        if msg.type == "tool":
            artifact = msg.artifact
            if artifact and "structured_content" in artifact:
                return artifact["structured_content"]

    return None


def print_schema(schema):
    """
    Pretty print schema for debugging / validation
    """
    print("\n================ DATASET SCHEMA ================\n")

    print("ðŸ“Š Tables:\n")
    for table in schema["Tables"]:
        print(f"ðŸ“ {table['Name']}")
        for col in table["Columns"]:
            print(f"   â””â”€ {col['Name']} ({col['Type']})")
        print()

    print("\nðŸ”— Relationships:\n")
    for rel in schema["ActiveRelationships"]:
        print(f"{rel['PK']}  --->  {rel['FK']}")


async def main():
    print("ðŸ” Generating Azure access token...")
    token = get_azure_access_token()

    # Connect to Fabric MCP Endpoint
    servers = {
        "powerbi-remote": {
            "transport": "http",
            "url": "https://api.fabric.microsoft.com/v1/mcp/powerbi",
            "headers": {
                "Authorization": f"Bearer {token}"
            }
        }
    }

    print("ðŸ”Œ Connecting to MCP server...")
    client = MultiServerMCPClient(servers)

    tools = await client.get_tools()
    print(f"âœ… Connected. Discovered {len(tools)} MCP tools")

    # Initialize LLM (will be used later for reasoning)
    model = init_chat_model(
        os.getenv("MODEL"),
        model_provider="openai",
        api_key=os.getenv("GITHUB_TOKEN"),
        base_url=os.getenv("ENDPOINT"),
    )

    system_prompt = """
    You are a FinOps analyst working with Power BI semantic models through MCP.
    Always use MCP tools to inspect datasets. Never assume schema.
    """

    agent_graph = create_agent(model, tools, system_prompt=system_prompt, debug=False)

    workspace_id = os.getenv("POWERBI_WORKSPACE_ID")
    dataset_id = os.getenv("POWERBI_DATASET_ID")

    query = f"""
    Using the Power BI MCP tools, answer the following:

    What is the current total cloud cost based on the latest available data?

    Workspace ID: {workspace_id}
    Dataset ID: {dataset_id}
    """

    print("ðŸ“Š Fetching semantic model schema...")
    result = await agent_graph.ainvoke(
        {"messages": [{"role": "user", "content": query}]}
    )

    # âœ… Extract REAL DATA
    schema = extract_mcp_schema(result)

    if not schema:
        print("âŒ No schema returned from MCP")
        return

    print_schema(schema)

    # You will reuse this schema for FinOps reasoning later
    print("\nâœ… MCP integration validated successfully.\n")


if __name__ == "__main__":
    asyncio.run(main())

why the above code is giving me the same output every time
(mcp-help) PS C:\Users\KANSUL\mcp-help> python openAI_mcp.py
C:\Users\KANSUL\mcp-help\.venv\Lib\site-packages\langchain_core\_api\deprecation.py:25: UserWarning: Core Pydantic V1 functionality isn't compatible with Python 3.14 or greater.
  from pydantic.v1.fields import FieldInfo as FieldInfoV1
ðŸ” Generating Azure access token...
âœ… Azure token generated successfully
ðŸ”Œ Connecting to MCP server...
âœ… Connected. Discovered 3 MCP tools
ðŸ“Š Fetching semantic model schema...

================ DATASET SCHEMA ================

ðŸ“Š Tables:

ðŸ“ calendar
   â””â”€ date (DateTime)
   â””â”€ year (Text)
   â””â”€ quarter_no (Text)
   â””â”€ quarter_yy_no (Text)
   â””â”€ month_no (Double)
   â””â”€ month (Text)
   â””â”€ month_yy_no (Text)
   â””â”€ week_no (Double)
   â””â”€ week_yy_no (Text)
   â””â”€ day_of_week (Text)
   â””â”€ month_start (DateTime)
   â””â”€ month_end (DateTime)
   â””â”€ quarter_start (DateTime)
   â””â”€ quarter_end (DateTime)

ðŸ“ cost
   â””â”€ resId (Integer)
   â””â”€ date (DateTime)
   â””â”€ nok (Double)
   â””â”€ raw_usd (Double)
   â””â”€ category (Text)
   â””â”€ sub_category (Text)
   â””â”€ name (Text)
   â””â”€ customer_id (Text)
   â””â”€ kubeit (Integer)
   â””â”€ usd (Double)
   â””â”€ customer_name (Text)

ðŸ“ customers
   â””â”€ customer_id (Text)
   â””â”€ customer_name (Text)
   â””â”€ source (Integer)

ðŸ“ details
   â””â”€ resource_id (Integer)
   â””â”€ detail (Text)
   â””â”€ value (Text)
   â””â”€ startDate (DateTime)
   â””â”€ is_current (Integer)
   â””â”€ rn (Integer)
   â””â”€ endDate (DateTime)

ðŸ“ regions
   â””â”€ continent (Text)
   â””â”€ location (Text)
   â””â”€ geographyId (Text)
   â””â”€ latitude (Text)
   â””â”€ longitude (Text)
   â””â”€ typeId (Text)
   â””â”€ isOpen (Text)
   â””â”€ hasGroundStation (Text)
   â””â”€ yearOpen (Text)
   â””â”€ dataResidency (Text)
   â””â”€ availableTo (Text)
   â””â”€ announcementLink (Text)
   â””â”€ productsByRegionLink (Text)
   â””â”€ productsByRegionLinkNonRegional (Text)
   â””â”€ availabilityZonesId (Text)
   â””â”€ id (Text)
   â””â”€ displayName (Text)

ðŸ“ resources
   â””â”€ resource_id (Integer)
   â””â”€ subscription_id (Text)
   â””â”€ subscription_name (Text)
   â””â”€ location (Text)
   â””â”€ resource_group (Text)
   â””â”€ type (Text)
   â””â”€ name (Text)
   â””â”€ customer_id (Text)
   â””â”€ current_state (Text)
   â””â”€ last_updated_time (DateTime)
   â””â”€ customer_name (Text)

ðŸ“ subscriptions
   â””â”€ subscription_id (Text)
   â””â”€ subscription_name (Text)
   â””â”€ management_group (Text)
   â””â”€ management_group_name (Text)

ðŸ“ tags
   â””â”€ resource_id (Integer)
   â””â”€ product_centre (Text)
   â””â”€ solution_name (Text)
   â””â”€ environment (Text)
   â””â”€ project_number (Text)
   â””â”€ project_task (Text)
   â””â”€ owner (Text)
   â””â”€ verit-owneremail (Text)


ðŸ”— Relationships:

'subscriptions'[subscription_id]  --->  'resources'[subscription_id]
'tags'[resource_id]  --->  'resources'[resource_id]
'regions'[id]  --->  'resources'[location]
'resources'[resource_id]  --->  'tags'[resource_id]
'resources'[resource_id]  --->  'cost'[resId]
'calendar'[date]  --->  'cost'[date]
'resources'[resource_id]  --->  'details'[resource_id]

âœ… MCP integration validated successfully.
