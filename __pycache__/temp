import os
import asyncio
import certifi
import requests
from dotenv import load_dotenv

from langchain_mcp_adapters.client import MultiServerMCPClient

load_dotenv()

# Fix SSL issues in corporate environments
os.environ["SSL_CERT_FILE"] = certifi.where()


def get_azure_access_token():
    """
    Generates Azure AD token using Service Principal
    """
    tenant = os.getenv("AZURE_TENANT_ID")
    client_id = os.getenv("AZURE_CLIENT_ID")
    client_secret = os.getenv("AZURE_CLIENT_SECRET")

    if not tenant or not client_id or not client_secret:
        raise ValueError("Azure credentials missing in .env")

    url = f"https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"

    payload = {
        "client_id": client_id,
        "client_secret": client_secret,
        "scope": "https://analysis.windows.net/powerbi/api/.default",
        "grant_type": "client_credentials",
    }

    response = requests.post(url, data=payload)
    response.raise_for_status()

    print("‚úÖ Azure token generated successfully")
    return response.json()["access_token"]


async def main():
    print("üîê Generating Azure access token...")
    token = get_azure_access_token()

    # Connect to Fabric MCP Endpoint
    servers = {
        "powerbi-remote": {
            "transport": "http",
            "url": "https://api.fabric.microsoft.com/v1/mcp/powerbi",
            "headers": {"Authorization": f"Bearer {token}"}
        }
    }

    print("üîå Connecting to MCP server...")
    client = MultiServerMCPClient(servers)

    tools = await client.get_tools()

    print(f"‚úÖ Connected to MCP. Discovered {len(tools)} tools\n")

    print("üõ† Available MCP Tools:")
    for t in tools:
        print(" -", t.name)

    # Build tool map
    tool_map = {tool.name: tool for tool in tools}

    dataset_id = os.getenv("POWERBI_DATASET_ID")

    if not dataset_id:
        raise ValueError("POWERBI_DATASET_ID missing in .env")

    print("\nüîé Directly testing GetSemanticModelSchema (NO LLM)...\n")

    schema_tool = tool_map["GetSemanticModelSchema"]

    raw_schema = await schema_tool.ainvoke(
        {"artifactId": dataset_id},
        config={"run_name": "direct_schema_test"}
    )

    print("\n================ RAW SCHEMA RESPONSE ================\n")
    print(raw_schema)
    print("\n====================================================\n")


if __name__ == "__main__":
    asyncio.run(main())
