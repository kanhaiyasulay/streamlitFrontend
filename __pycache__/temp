# FinOps Agent – Technical Overview

## 1. Purpose

The FinOps Agent is a domain-specific AI agent designed to answer cloud cost-related queries using Power BI semantic models.  

It allows users to ask natural language questions such as:

- Cloud cost by year
- Cost by month
- Last 3 months cost
- Cost by subscription
- Comparison queries

The agent is scoped to **mydnvsoftware** data and always returns cost in NOK currency.

---

## 2. Technology Stack

| Component        | Technology Used |
|-----------------|----------------|
| LLM Framework   | LangChain |
| LLM Provider    | OpenAI-compatible endpoint |
| Data Source     | Power BI Semantic Model |
| Auth Mechanism  | Azure AD Service Principal |
| API Integration | Power BI REST API (ExecuteQueries) |

---

## 3. Power BI Configuration

- **Workspace Name:** Semantic model  
- **Dataset Name:** SWE-Cloud-Data  
- **Connection Type:** REST API (ExecuteQueries endpoint)  
- **Authentication:** Azure AD OAuth2 (Client Credentials Flow)

Required Environment Variables:
- ENDPOINT
- AZURE_TENANT_ID
- AZURE_CLIENT_ID
- AZURE_CLIENT_SECRET
- POWERBI_WORKSPACE_ID
- POWERBI_DATASET_ID

-----
## 4. High-Level Architecture

User → Streamlit UI → LangChain Agent → Tools → Power BI REST API → Response Formatter → User

### Flow Explanation

1. User enters natural language query.
2. Agent first calls `fetch_model_schema_compact()` to understand available tables, columns, and measures.
3. Agent generates a valid DAX query.
4. `execute_dax_query()` executes the query using Power BI ExecuteQueries API.
5. JSON result is returned.
6. Agent formats output into a clean, user-friendly response.
7. DAX query is NOT exposed to the user.

## 5. Agent Tools

### 5.1 fetch_model_schema_compact()

Purpose:
- Returns compact schema
- Includes table names, columns (with types), and measures
- Prevents token overflow
- Used before generating DAX

Internally uses:
- INFO.VIEW.TABLES()
- INFO.VIEW.COLUMNS()
- INFO.VIEW.MEASURES()
- INFO.VIEW.RELATIONSHIPS()

---

### 5.2 execute_dax_query(dax_query: str)

Purpose:
- Executes validated DAX query
- Calls:


POST https://api.powerbi.com/v1.0/myorg/groups/{workspaceId}/datasets/{datasetId}/executeQueries


Returns:
- Raw ExecuteQueries JSON
- Status metadata

------

## 6. Query Execution Flow (Detailed)

1. User Query
2. LLM interprets intent
3. Schema fetched (compact)
4. LLM builds DAX query
5. DAX executed via REST API
6. JSON rows extracted
7. Response formatted into readable output
8. Only final business answer shown

-----
