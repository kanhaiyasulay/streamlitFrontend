import os
import asyncio
import certifi
import requests
from dotenv import load_dotenv
from langchain_mcp_adapters.client import MultiServerMCPClient

# -----------------------------
# ENV SETUP
# -----------------------------
load_dotenv()
os.environ["SSL_CERT_FILE"] = certifi.where()


# -----------------------------
# AUTHENTICATION
# -----------------------------
def get_azure_access_token():
    tenant = os.getenv("AZURE_TENANT_ID")
    client_id = os.getenv("AZURE_CLIENT_ID")
    client_secret = os.getenv("AZURE_CLIENT_SECRET")

    if not tenant or not client_id or not client_secret:
        raise ValueError("Azure credentials missing in .env")

    url = f"https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"

    payload = {
        "client_id": client_id,
        "client_secret": client_secret,
        "scope": "https://analysis.windows.net/powerbi/api/.default",
        "grant_type": "client_credentials",
    }

    print("üîê Requesting Azure token...")
    response = requests.post(url, data=payload)
    response.raise_for_status()

    print("‚úÖ Azure token generated successfully")
    return response.json()["access_token"]


# -----------------------------
# MCP RESPONSE NORMALIZER
# -----------------------------
def extract_artifact(result):
    """
    Handles ALL MCP return formats seen in langchain_mcp_adapters:

    1Ô∏è‚É£ Object with `.artifact`
    2Ô∏è‚É£ List of ToolMessage objects
    3Ô∏è‚É£ Plain list of dictionaries (most common issue)
    4Ô∏è‚É£ Already-unwrapped structured_content
    """

    # Case 1 ‚Äî Direct object
    if hasattr(result, "artifact"):
        return result.artifact

    # Case 2/3 ‚Äî List response
    if isinstance(result, list):
        for item in result:

            # ToolMessage style
            if hasattr(item, "artifact") and item.artifact:
                return item.artifact

            # Dict style
            if isinstance(item, dict):

                if "artifact" in item:
                    return item["artifact"]

                if "structured_content" in item:
                    return item

    raise ValueError(f"‚ùå Unrecognized MCP response format:\n{result}")


# -----------------------------
# SIMPLE INTENT CLASSIFIER
# -----------------------------
def classify_question(q: str) -> str:
    q = q.lower()

    if any(word in q for word in ["schema", "table", "column", "structure"]):
        return "schema"

    return "analysis"


# -----------------------------
# PRINT SCHEMA
# -----------------------------
def print_schema(schema):
    print("\n================ DATASET SCHEMA ================\n")

    for table in schema["Tables"]:
        print(f"üìÅ {table['Name']}")
        for col in table["Columns"]:
            print(f"   ‚îî‚îÄ {col['Name']} ({col['Type']})")
        print()

    print("\nüîó Relationships:\n")
    for rel in schema["ActiveRelationships"]:
        print(f"{rel['PK']}  --->  {rel['FK']}")


# -----------------------------
# MAIN EXECUTION
# -----------------------------
async def main():
    print("üîê Generating Azure access token...")
    token = get_azure_access_token()

    workspace_id = os.getenv("POWERBI_WORKSPACE_ID")
    dataset_id = os.getenv("POWERBI_DATASET_ID")

    if not workspace_id or not dataset_id:
        raise ValueError("Missing POWERBI_WORKSPACE_ID or POWERBI_DATASET_ID")

    # MCP Connection
    servers = {
        "powerbi-remote": {
            "transport": "http",
            "url": "https://api.fabric.microsoft.com/v1/mcp/powerbi",
            "headers": {
                "Authorization": f"Bearer {token}",
                "x-ms-powerbi-workspace-id": workspace_id,
                "Content-Type": "application/json"
            }
        }
    }

    print("üîå Connecting to MCP server...")
    client = MultiServerMCPClient(servers)

    tools = await client.get_tools()
    tool_map = {tool.name: tool for tool in tools}

    print(f"‚úÖ Connected. Available tools: {list(tool_map.keys())}")

    print("\n‚úÖ FinOps MCP Client Ready.")
    print("Type your question (or 'exit' to quit).\n")

    while True:
        user_question = input("Ask FinOps question: ").strip()

        if user_question.lower() in ["exit", "quit"]:
            print("üëã Exiting.")
            break

        intent = classify_question(user_question)

        try:
            # -----------------------------
            # SCHEMA REQUEST
            # -----------------------------
            if intent == "schema":
                print("üì° Fetching schema from MCP...")

                schema_tool = tool_map["GetSemanticModelSchema"]

                result = await schema_tool.ainvoke({
                    "artifactId": dataset_id
                })

                # Debug once (can remove later)
                print("DEBUG ‚Üí MCP returned type:", type(result))

                artifact = extract_artifact(result)
                schema = artifact["structured_content"]

                print_schema(schema)

            # -----------------------------
            # ANALYSIS (NEXT PHASE)
            # -----------------------------
            else:
                print("‚ö†Ô∏è Analysis path not implemented yet.")
                print("Next step: generate DAX locally and call ExecuteQuery.")

        except Exception as e:
            print("\n‚ùå MCP ERROR:")
            print(e)

        print("\n" + "-" * 60 + "\n")


# -----------------------------
# ENTRY POINT
# -----------------------------
if __name__ == "__main__":
    asyncio.run(main())
